

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>GRPC - Sad man</title><meta name="Description" content=""><meta property="og:title" content="GRPC" />
<meta property="og:description" content="一、环境配置安装 brew install protobuf protoc --proto_path=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/proto/ --java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ --grpc-java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ raft.proto 二、 gRPC 核心的设计思路 1. gRPC 与 ThriftRPC 区别 共性：支持异构语言的RPC。 区别： 1. 网络通信 Thrift TCP 专属协议 GRPC HTTP2 2. 性能角度 ThriftRPC 性能" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sad-man-shang.github.io/grpc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-30T15:53:16+10:00" />
<meta property="article:modified_time" content="2023-07-30T15:53:16+10:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GRPC"/>
<meta name="twitter:description" content="一、环境配置安装 brew install protobuf protoc --proto_path=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/proto/ --java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ --grpc-java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ raft.proto 二、 gRPC 核心的设计思路 1. gRPC 与 ThriftRPC 区别 共性：支持异构语言的RPC。 区别： 1. 网络通信 Thrift TCP 专属协议 GRPC HTTP2 2. 性能角度 ThriftRPC 性能"/>
<meta name="application-name" content="Sad man">
<meta name="apple-mobile-web-app-title" content="Sad man">

<meta name="theme-color" content="#f8f8f8"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="https://sad-man-shang.github.io/grpc/" /><link rel="prev" href="https://sad-man-shang.github.io/%E7%AC%94%E8%AF%95%E7%9C%9F%E9%A2%98/" /><link rel="next" href="https://sad-man-shang.github.io/parkmate/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "GRPC",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/sad-man-shang.github.io\/grpc\/"
        },"genre": "posts","keywords": "面试","wordcount":  13129 ,
        "url": "https:\/\/sad-man-shang.github.io\/grpc\/","datePublished": "2023-07-30T15:53:16+10:00","dateModified": "2023-07-30T15:53:16+10:00","publisher": {
            "@type": "Organization",
            "name": "Sad man"},"authors": [{
                        "@type": "Person",
                        "name": "Sad_man"                    
                    }],"description": ""
    }
    </script><script src="//instant.page/5.2.0" defer type="module" integrity="sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Sad man">Sad man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/series/"> 系列 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Sad man">Sad man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/series/" title="">系列</a><a href="javascript:void(0);" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "false")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">GRPC</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><span class="author fas fa-user-circle fa-fw"></span><span class='screen-reader-text'>  </span><a href='https://sad-man-shang.github.io/authors/sad_man'>Sad_man</a></span>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/rpc/"><i class="far fa-folder fa-fw"></i>rpc</a></span>&nbsp;<span class="post-category">和</span>&nbsp;<span class="post-series">系列 <a href="/series/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="far fa-list-alt fa-fw"></i>学习笔记</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-07-30">2023-07-30</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-07-30">2023-07-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 13129 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 27 分钟&nbsp;</div>
        </div><div class="details series-nav open">
                                <div class="details-summary series-title">
                                    <span>系列 - 学习笔记</span>
                                    <span><i class="details-icon fas fa-angle-right"></i></span>
                                </div>
                                <div class="details-content series-content">
                                    <nav>
                                        <ul>
                                                    <li><a href="/springsourcecode/">Spring关键源码阅读</a></li>
                                                    <li><a href="/interview/">Interview</a></li>
                                                    <li><a href="/parkmate/">Parkmate</a></li><li><span class="active">GRPC</span></li>
                                                    <li><a href="/%E7%AC%94%E8%AF%95%E7%9C%9F%E9%A2%98/">笔试真题</a></li>
                                                    <li><a href="/mysql/">Mysql</a></li>
                                                    <li><a href="/%E6%AF%8F%E6%97%A5%E5%88%B7%E9%A2%98/">LeetCode 热题 HOT 100</a></li></ul>
                                    </nav>
                                </div>
                            </div><div class="content" id="content"><h1 id="一环境配置" class="headerLink">
    <a href="#%e4%b8%80%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae" class="header-mark"></a>一、环境配置</h1><p>安装</p>
<p><code>brew install protobuf</code></p>
<pre tabindex="0"><code>protoc --proto_path=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/proto/ --java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ --grpc-java_out=/Users/shengquan/Downloads/CS/Program/Java/Raft_KV_Platform/src/main/java/ raft.proto
</code></pre><h1 id="二" class="headerLink">
    <a href="#%e4%ba%8c" class="header-mark"></a>二、</h1><h2 id="grpc-核心的设计思路" class="headerLink">
    <a href="#grpc-%e6%a0%b8%e5%bf%83%e7%9a%84%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af" class="header-mark"></a>gRPC 核心的设计思路</h2><pre><code>        1. 
</code></pre>
<ol start="3">
<li>
<p>gRPC 与 ThriftRPC 区别
共性：支持异构语言的RPC。
区别：
1. 网络通信 Thrift TCP   专属协议
GRPC   HTTP2
2. 性能角度 ThriftRPC 性能 高于 gRPC
3. gRPC 大厂背书（Google),云原生时代 与其他组件合作的顺利。所以gRPC应用更广泛。</p>
</li>
<li>
<p>gRPC的好处</p>
<ol>
<li>高效的进行进程间通信。</li>
<li>支持多种语言 原生支持 C  Go Java实现。C语言版本上扩展 C++ C# NodeJS Python Ruby PHP..</li>
<li>支持多平台运行 Linux Android IOS MacOS Windows。</li>
<li>gPRC序列化方式采用protobuf，效率高。</li>
<li>使用Http2协议</li>
<li>大厂的背书</li>
</ol>
</li>
</ol>
<h2 id="http2" class="headerLink">
    <a href="#http2" class="header-mark"></a>http2</h2><ol>
<li>回顾 Http1.x协议
Http1.0协议  请求响应的模式 短连接协议（无状态协议）  传输数据文本结构     单工 无法实现服务端推送 变相实现推动（客户端轮训的方式）
Http1.1协议  请求响应的模式 有限的长连接            升级的方式WebSocket 双工 实现服务器向客户端推送。
总结Http1.x协议 共性
<ol>
<li>传输数据文本格式 可读性好的但是效率差。</li>
<li>本质上Http1.x协议无法实现双工通信。</li>
<li>资源的请求。需要发送多次请求，建立多个连接才可以完成。</li>
</ol>
</li>
<li>HTTP2.0协议
<ol>
<li>Http2.0协议是一个二进制协议，效率高于Http1.x协议，可读性差。</li>
<li>可以实现双工通信。</li>
<li>一个请求 一个连接 可以请求多个数据。【多路复用】</li>
</ol>
</li>
<li>Http2.0协议的三个概念
<ol>
<li>数据流 stream</li>
<li>消息   message</li>
<li>帧    frame    参看图</li>
</ol>
</li>
<li>其他的相关概念
<ol>
<li>数据流的优先级，可以通过为不同的stream设置权重，来限制不同流的传输顺序。</li>
<li>流控 client发送的数据太快了，server处理不过来，通知client暂停数据的发送。</li>
</ol>
</li>
</ol>
<h2 id="protobuf" class="headerLink">
    <a href="#protobuf" class="header-mark"></a>Protobuf</h2><ul>
<li>
<p>文件格式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">.proto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">UserService.proto
</span></span><span class="line"><span class="cl">OrderService.proto
</span></span></code></pre></div></li>
<li>
<p>版本设定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">syntax = &#34;proto3&#34;;
</span></span></code></pre></div></li>
<li>
<p>注释</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 单行注释   //
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 多行注释   /*    */
</span></span></code></pre></div></li>
<li>
<p>与Java语言相关的语法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh">#后续protobuf生成的java代码 一个源文件还是多个源文件  xx.java
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_multiple_files = false; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">#指定protobuf生成的类 放置在哪个包中
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_package = &#34;com.example&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">#指定的protobuf生成的外部类的名字（管理内部类【内部类才是真正开发使用】）
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_outer_classname = &#34;UserServce&#34;;
</span></span></code></pre></div></li>
<li>
<p>逻辑包【了解】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh"># 对于protobuf对于文件内容的管理
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>package xxx;
</span></span></code></pre></div></li>
<li>
<p>导入，复用其他proto文件中定义的Message</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">UserService.proto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OrderService.proto
</span></span><span class="line"><span class="cl">  import &#34;xxx/UserService.proto&#34;;
</span></span></code></pre></div></li>
<li>
<p>基本类型</p>
<table>
<thead>
<tr>
<th>.proto Type</th>
<th>Notes</th>
<th>C++ Type</th>
<th>Java Type</th>
<th>Python Type[2]</th>
<th>Go Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>double</td>
<td></td>
<td>double</td>
<td>double</td>
<td>float</td>
<td>*float64</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>float</td>
<td>float</td>
<td>float</td>
<td>*float32</td>
</tr>
<tr>
<td>int32</td>
<td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint32 instead.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>*int32</td>
</tr>
<tr>
<td>int64</td>
<td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint64 instead.</td>
<td>int64</td>
<td>long</td>
<td>int/long[3]</td>
<td>*int64</td>
</tr>
<tr>
<td>uint32</td>
<td>Uses variable-length encoding.</td>
<td>uint32</td>
<td>int[1]</td>
<td>int/long[3]</td>
<td>*uint32</td>
</tr>
<tr>
<td>uint64</td>
<td>Uses variable-length encoding.</td>
<td>uint64</td>
<td>long[1]</td>
<td>int/long[3]</td>
<td>*uint64</td>
</tr>
<tr>
<td>sint32</td>
<td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int32s.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>*int32</td>
</tr>
<tr>
<td>sint64</td>
<td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int64s.</td>
<td>int64</td>
<td>long</td>
<td>int/long[3]</td>
<td>*int64</td>
</tr>
<tr>
<td>fixed32</td>
<td>Always four bytes. More efficient than uint32 if values are often greater than 228.</td>
<td>uint32</td>
<td>int[1]</td>
<td>int/long[3]</td>
<td>*uint32</td>
</tr>
<tr>
<td>fixed64</td>
<td>Always eight bytes. More efficient than uint64 if values are often greater than 256.</td>
<td>uint64</td>
<td>long[1]</td>
<td>int/long[3]</td>
<td>*uint64</td>
</tr>
<tr>
<td>sfixed32</td>
<td>Always four bytes.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>*int32</td>
</tr>
<tr>
<td>sfixed64</td>
<td>Always eight bytes.</td>
<td>int64</td>
<td>long</td>
<td>int/long[3]</td>
<td>*int64</td>
</tr>
<tr>
<td>bool</td>
<td></td>
<td>bool</td>
<td>boolean</td>
<td>bool</td>
<td>*bool</td>
</tr>
<tr>
<td>string</td>
<td>A string must always contain UTF-8 encoded text.</td>
<td>string</td>
<td>String</td>
<td>unicode (Python 2) or str (Python 3)</td>
<td>*string</td>
</tr>
<tr>
<td>bytes</td>
<td>May contain any arbitrary sequence of bytes.</td>
<td>string</td>
<td>ByteString</td>
<td>bytes</td>
<td>[]byte</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>枚举，枚举的值必须从0开始</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">SEASON</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">SPRING</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">SUMMER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div></li>
<li>
<p>消息 Message</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">LoginRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">string</span> <span class="n">username</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">singular</span> <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">int32</span>  <span class="n">age</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">编号</span> <span class="err">从</span><span class="mi">1</span><span class="err">开始</span> <span class="err">到</span><span class="mi">2</span><span class="err">^</span><span class="mi">29</span><span class="o">-</span><span class="mi">1</span>  <span class="err">注意：</span><span class="mi">19000</span> <span class="o">-</span> <span class="mi">19999</span> <span class="err">不能用这个区间内的编号，因为他是</span><span class="n">protobuf</span><span class="err">自己保留的。
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="o">-</span> <span class="n">singular</span> <span class="o">:</span> <span class="err">这个字段的值</span> <span class="err">只能是</span><span class="mi">0</span><span class="err">个或</span><span class="mi">1</span><span class="err">个</span> <span class="err">（默认关键字）</span>  <span class="n">null</span>   <span class="s">&#34;123456&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="o">-</span> <span class="k">repeated</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">Result</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">string</span> <span class="n">content</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">repeated</span> <span class="kt">string</span> <span class="n">stutas</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//这个字段 返回值 是多个 等价于 Java List Protobuf getStatusList()--&gt;List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c1">// 可以定义多个消息 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">message</span> <span class="nc">LoginRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="o">....</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">LoginResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="o">...</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">消息可以嵌套</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">SearchResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kd">message</span> <span class="nc">Result</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">url</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">title</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">xxx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int32</span>  <span class="n">yyy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="n">Result</span> <span class="n">ppp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c1">// message外部使用SearchResponse.Result
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">message</span> <span class="nc">AAA</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">xxx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="n">SearchResponse.Result</span> <span class="n">yyy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">oneof</span> <span class="p">[</span><span class="err">其中一个</span><span class="p">]</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">SimpleMessage</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">oneof</span> <span class="n">test_oneof</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">int32</span>  <span class="n">age</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">test_oneof</span> <span class="n">xxx</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div></li>
<li>
<p>服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">service</span> <span class="n">HelloService</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">rpc</span> <span class="n">hello</span><span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">HelloResponse</span><span class="p">){}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c1">// 里面是可以定义多个服务方法。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 定义多个服务接口
</span></span></span><span class="line"><span class="cl"><span class="c1">// gPRC 服务 4个服务方式 。
</span></span></span></code></pre></div></li>
</ul>
<h1 id="实战开始" class="headerLink">
    <a href="#%e5%ae%9e%e6%88%98%e5%bc%80%e5%a7%8b" class="header-mark"></a>实战开始</h1><p>自动编译proto文件称java文件</p>
<p><a href="https://github.com/grpc/grpc-java" target="_blank" rel="noopener noreferrer">https://github.com/grpc/grpc-java</a></p>
<p>————————————————————————————</p>
<h1 id="一核心思路" class="headerLink">
    <a href="#%e4%b8%80%e6%a0%b8%e5%bf%83%e6%80%9d%e8%b7%af" class="header-mark"></a>一、核心思路</h1><h2 id="1-核心思路" class="headerLink">
    <a href="#1-%e6%a0%b8%e5%bf%83%e6%80%9d%e8%b7%af" class="header-mark"></a>1. 核心思路</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> gRPC 核心的设计思路 
</span></span><span class="line"><span class="cl">         <span class="k">1.</span> 网络通信 ---&gt; gRPC自己封装网络通信的部分 提供多种语言的 网络通信的封装 （C Java[Netty] GO)
</span></span><span class="line"><span class="cl">         <span class="k">2.</span> 协议    ---&gt; HTTP2 传输数据的时候 二进制数据内容。 支持双向流（双工）连接的多路复用。
</span></span><span class="line"><span class="cl">         <span class="k">3.</span> 序列化   ---&gt; 基本文本 JSON  基于二进制 Java原生序列化方式 Thrift二进制的序列化 压缩二级制序列化。
</span></span><span class="line"><span class="cl">                         protobuf (Protocol Buffers) google开源一种序列化方式  时间效率和空间效率是JSON的3---5倍。
</span></span><span class="line"><span class="cl">                         IDL语言 
</span></span><span class="line"><span class="cl">         <span class="k">4.</span> 代理的创建 ---&gt;让调用者像调用本地方法那样 去调用远端的服务方法。
</span></span><span class="line"><span class="cl">                          stub
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">2.</span> gRPC的好处 
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 高效的进行进程间通信。
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 支持多种语言 原生支持 C  Go Java实现。C语言版本上扩展 C++ C# NodeJS Python Ruby PHP..
</span></span><span class="line"><span class="cl">   <span class="k">3.</span> 支持多平台运行 Linux Android IOS MacOS Windows。
</span></span><span class="line"><span class="cl">   <span class="k">4.</span> gPRC序列化方式采用protobuf，效率高。
</span></span><span class="line"><span class="cl">   <span class="k">5.</span> 使用Http2协议
</span></span><span class="line"><span class="cl">   <span class="k">6.</span> 大厂的背书
</span></span></code></pre></div><h2 id="2-http20协议" class="headerLink">
    <a href="#2-http20%e5%8d%8f%e8%ae%ae" class="header-mark"></a>2. Http2.0协议</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 回顾 Http1.x协议 
</span></span><span class="line"><span class="cl">   Http1.0协议  请求响应的模式 短连接协议（无状态协议）  传输数据文本结构     单工 无法实现服务端推送 变相实现推动（客户端轮训的方式） 
</span></span><span class="line"><span class="cl">   Http1.1协议  请求响应的模式 有限的长连接            升级的方式WebSocket 双工 实现服务器向客户端推送。
</span></span><span class="line"><span class="cl">   总结Http1.x协议 共性
</span></span><span class="line"><span class="cl">     <span class="k">1.</span> 传输数据文本格式 可读性好的但是效率差。
</span></span><span class="line"><span class="cl">     <span class="k">2.</span> 本质上Http1.x协议无法实现双工通信。
</span></span><span class="line"><span class="cl">     <span class="k">3.</span> 资源的请求。需要发送多次请求，建立多个连接才可以完成。 
</span></span><span class="line"><span class="cl"><span class="k">2.</span> HTTP2.0协议 
</span></span><span class="line"><span class="cl">     <span class="k">1.</span> Http2.0协议是一个二进制协议，效率高于Http1.x协议，可读性差。
</span></span><span class="line"><span class="cl">     <span class="k">2.</span> 可以实现双工通信。
</span></span><span class="line"><span class="cl">     <span class="k">3.</span> 一个请求 一个连接 可以请求多个数据。【多路复用】
</span></span><span class="line"><span class="cl"><span class="k">3.</span> Http2.0协议的三个概念
</span></span><span class="line"><span class="cl">     <span class="k">1.</span> 数据流 stream
</span></span><span class="line"><span class="cl">     <span class="k">2.</span> 消息   message
</span></span><span class="line"><span class="cl">     <span class="k">3.</span> 帧    frame    参看图
</span></span><span class="line"><span class="cl"><span class="k">4.</span> 其他的相关概念
</span></span><span class="line"><span class="cl">     <span class="k">1.</span> 数据流的优先级，可以通过为不同的stream设置权重，来限制不同流的传输顺序。
</span></span><span class="line"><span class="cl">     <span class="k">2.</span> 流控 client发送的数据太快了，server处理不过来，通知client暂停数据的发送。
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png" title="image-20230305203847598" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305203847598.png 2x"
            sizes="auto"
            alt="image-20230305203847598">
    </a></figure></p>
<h2 id="3-protocol-buffers-protobuf" class="headerLink">
    <a href="#3-protocol-buffers-protobuf" class="header-mark"></a>3 Protocol Buffers [protobuf]</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> protobuf 是一种与编程语言无关【IDL】,与具体的平台无关【OS】。他定义的中间语言，可以方便的在client 于 server中进行RPC的数据传输。
</span></span><span class="line"><span class="cl"><span class="k">2.</span> protobuf 两种版本 proto2 proto3,但是目前主流应用的都是proto3。
</span></span><span class="line"><span class="cl"><span class="k">3.</span> protobuf主要安装protobuf的编译器，编译器目的，可以把protobuf的IDL语言，转换成具体某一种开发语言。
</span></span></code></pre></div><h2 id="4-protobuf编译器的安装" class="headerLink">
    <a href="#4-protobuf%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%ae%89%e8%a3%85" class="header-mark"></a>4 protobuf编译器的安装</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">https://github.com/protocolbuffers/protobuf/releases
</span></span><span class="line"><span class="cl">windows 版本
</span></span><span class="line"><span class="cl">  <span class="k">1.</span> 直接解压缩 方式在一个特定的目录下面
</span></span><span class="line"><span class="cl">  <span class="k">2.</span> 直接配置环境变量 path
</span></span><span class="line"><span class="cl">     protoc --version
</span></span><span class="line"><span class="cl">mac    版本
</span></span><span class="line"><span class="cl">  brew install protobuf 
</span></span><span class="line"><span class="cl">     protoc --version
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png" title="image-20230305205216711" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230305205216711.png 2x"
            sizes="auto"
            alt="image-20230305205216711">
    </a></figure></p>
<h2 id="5-protobuf-idea的插件" class="headerLink">
    <a href="#5-protobuf-idea%e7%9a%84%e6%8f%92%e4%bb%b6" class="header-mark"></a>5 protobuf IDEA的插件</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 2021.2版本后面的新版本 IDEA内置了Protobuf插件
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 之前版本 可以选装第三方Protobuf插件
</span></span><span class="line"><span class="cl"><span class="k">3.</span> 二者不能共存。
</span></span></code></pre></div><h2 id="6-protobuf的语法详解" class="headerLink">
    <a href="#6-protobuf%e7%9a%84%e8%af%ad%e6%b3%95%e8%af%a6%e8%a7%a3" class="header-mark"></a>6. protobuf的语法详解</h2><ul>
<li>
<p>文件格式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">.proto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">UserService.proto
</span></span><span class="line"><span class="cl">OrderService.proto
</span></span></code></pre></div></li>
<li>
<p>版本设定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">syntax = &#34;proto3&#34;;
</span></span></code></pre></div></li>
<li>
<p>注释</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 单行注释   //
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 多行注释   /*    */
</span></span></code></pre></div></li>
<li>
<p>与Java语言相关的语法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh">#后续protobuf生成的java代码 一个源文件还是多个源文件  xx.java
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_multiple_files = false; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">#指定protobuf生成的类 放置在哪个包中
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_package = &#34;com.suns&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">#指定的protobuf生成的外部类的名字（管理内部类【内部类才是真正开发使用】）
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>option java_outer_classname = &#34;UserServce&#34;;
</span></span></code></pre></div></li>
<li>
<p>逻辑包【了解】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh"># 对于protobuf对于文件内容的管理
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>package xxx;
</span></span></code></pre></div></li>
<li>
<p>导入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">UserService.proto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OrderService.proto
</span></span><span class="line"><span class="cl">  import &#34;xxx/UserService.proto&#34;;
</span></span></code></pre></div></li>
<li>
<p>基本类型</p>
<p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png" title="image-20230307104440839" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230307104440839.png 2x"
            sizes="auto"
            alt="image-20230307104440839">
    </a></figure></p>
</li>
<li>
<p>枚举</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">SEASON</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">SPRING</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">SUMMER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">枚举的值</span> <span class="err">必须是</span><span class="mi">0</span><span class="err">开始</span> <span class="err">
</span></span></span></code></pre></div></li>
<li>
<p>消息 Message</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">LoginRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">string</span> <span class="n">username</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">singular</span> <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">int32</span>  <span class="n">age</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">编号</span> <span class="err">从</span><span class="mi">1</span><span class="err">开始</span> <span class="err">到</span><span class="mi">2</span><span class="err">^</span><span class="mi">29</span><span class="o">-</span><span class="mi">1</span><span class="err">，只有</span><span class="mi">29</span><span class="err">位是因为还有</span><span class="mi">5</span><span class="err">中</span><span class="n">wire</span> <span class="n">types</span><span class="err">需要表示，</span><span class="mi">5</span><span class="err">中方式需要</span><span class="mi">3</span><span class="err">位来表示。
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">注意：</span><span class="mi">19000</span> <span class="o">-</span> <span class="mi">19999</span> <span class="err">不能用这个区间内的编号，因为他是</span><span class="n">protobuf</span><span class="err">自己保留的。
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="o">-</span> <span class="n">singular</span> <span class="o">:</span> <span class="err">这个字段的值</span> <span class="err">只能是</span><span class="mi">0</span><span class="err">个或</span><span class="mi">1</span><span class="err">个</span> <span class="err">（默认关键字）</span>  <span class="n">null</span>   <span class="s">&#34;123456&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="o">-</span> <span class="k">repeated</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">Result</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kt">string</span> <span class="n">content</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">repeated</span> <span class="kt">string</span> <span class="n">stutas</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//这个字段 返回值 是多个 等价于 Java List Protobuf getStatusList()--&gt;List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="n">protobuf</span> <span class="p">[</span><span class="n">grpc</span><span class="p">]</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">可以定义多个消息</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">LoginRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="o">....</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">LoginResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="o">...</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">消息可以嵌套</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">SearchResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="kd">message</span> <span class="nc">Result</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">url</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">title</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">xxx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int32</span>  <span class="n">yyy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="n">Result</span> <span class="n">ppp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="n">SearchResponse.Result</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">AAA</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">xxx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="n">SearchResponse.Result</span> <span class="n">yyy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">oneof</span> <span class="p">[</span><span class="err">其中一个</span><span class="p">]</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">SimpleMessage</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">oneof</span> <span class="n">test_oneof</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      <span class="kt">int32</span>  <span class="n">age</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="n">test_oneof</span> <span class="n">xxx</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>message布局</p>
<p>一个 Protocol Buffers 的 message 在被序列化后的字节流中的<strong>布局</strong>大致如下：</p>
<ul>
<li>
<p>每个字段都会被编码为一连串的字节。字段的编码以字段的 tag 开始，tag 是字段的编号和字段的 wire type 编码后的结果。tag 的编码也是一个 varint。</p>
</li>
<li>
<p>字段的 tag 之后是字段的值，其编码方式取决于字段的 wire type。例如，如果 wire type 是 0（Varint），那么字段的值就会被编码为 varint。如果 wire type 是 2（Length-delimited），那么字段的值将先是一个表示长度的 varint，后是指定长度的字节。</p>
</li>
<li>
<p>字段按照在 message 中声明的顺序出现。但是，由于 Protocol Buffers 支持向前和向后兼容性，所以字段可以在任何顺序出现，甚至可以出现多次（尽管这样会浪费空间）。</p>
</li>
<li>
<p>重复的字段（使用 &ldquo;repeated&rdquo; 关键字声明的）可以被编码为多···个连续的字段（每个字段都有自己的 tag 和值），或者被编码为一个字段（这个字段的 wire type 是 2，也就是 Length-delimited），这个字段的值是所有重复字段的值的串联。</p>
</li>
<li>
<p>对于嵌套的 message，其编码方式与顶层的 message 相同，都是 tag + value 的形式，只不过 value 的内容是内部的 message。</p>
</li>
</ul>
<p>这样的编码方式可以确保即使消息定义发生改变，也可以正确地解析消息中的字段。如果字节流中有未知的字段（也就是在消息定义中不存在的字段），那么这些字段可以被安全地忽略或按原样保留，以便在转发时使用。</p>
<p>在 Protocol Buffers 中，每一个字段的类型都会被编码为一个 wire type，这用于表示该字段在字节流中的编码方式。Protobuf 定义了 5 种不同的 wire types：</p>
<ol>
<li>
<p>Varint（变长整数，wire type = 0）: 用于编码 bool、int32、int64、uint32、uint64、sint32、sint64、enum 等类型。</p>
</li>
<li>
<p>64-bit（64位固定长度，wire type = 1）: 用于编码 double、fixed64、sfixed64 等类型。</p>
</li>
<li>
<p>Length-delimited（长度有限的，wire type = 2）: 用于编码 string、bytes、embedded messages、packed repeated fields 等类型。</p>
</li>
<li>
<p>Start group（开始组，已废弃，wire type = 3）: 用于组的开始标记，但是这个类型已经在 Protocol Buffers v2 及以后的版本中废弃了。</p>
</li>
<li>
<p>End group（结束组，已废弃，wire type = 4）: 用于组的结束标记，但是这个类型也已经在 Protocol Buffers v2 及以后的版本中废弃了。</p>
</li>
<li>
<p>32-bit（32位固定长度，wire type = 5）: 用于编码 float、fixed32、sfixed32 等类型。</p>
</li>
</ol>
<p>所以，wire type 不仅表示字段在字节流中的编码方式，还决定了该字段在序列化和反序列化过程中的处理方式。</p>
</li>
<li>
<p>服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">service</span> <span class="n">HelloService</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>   <span class="k">rpc</span> <span class="n">hello</span><span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">HelloResponse</span><span class="p">){}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="err">里面是可以定义多个服务方法。
</span></span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="err">定义多个服务接口
</span></span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="n">gPRC</span> <span class="err">服务</span> <span class="mi">4</span><span class="err">个服务方式</span> <span class="err">。
</span></span></span></code></pre></div></li>
</ul>
<h1 id="二第一个gprc的开发" class="headerLink">
    <a href="#%e4%ba%8c%e7%ac%ac%e4%b8%80%e4%b8%aagprc%e7%9a%84%e5%bc%80%e5%8f%91" class="header-mark"></a>二、第一个gPRC的开发</h1><p>项目结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> xxxx-api 模块 
</span></span><span class="line"><span class="cl">   定义 protobuf idl语言 
</span></span><span class="line"><span class="cl">   并且通过命令创建对应的代码
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> service 
</span></span><span class="line"><span class="cl"><span class="k">2.</span> xxxx-server模块
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 实现api模块中定义的服务接口
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 发布gRPC服务 (创建服务端程序)
</span></span><span class="line"><span class="cl"><span class="k">3.</span> xxxx-clien模块
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 创建服务端stub(代理)
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 基于代理（stub) RPC调用。
</span></span></code></pre></div><p>api模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> .proto文件 书写protobuf的IDL
</span></span><span class="line"><span class="cl"><span class="k">2.</span> [了解]protoc命令 把proto文件中的IDL 转换成编程语言 
</span></span><span class="line"><span class="cl">   protoc --java_out=/xxx/xxx  /xxx/xxx/xx.proto
</span></span><span class="line"><span class="cl"><span class="k">3.</span> maven插件 进行protobuf IDL文件的编译，并把他放置IDEA具体位置。
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">pom.xml
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.grpc<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>grpc-netty-shaded<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.52.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.grpc<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>grpc-protobuf<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.52.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.grpc<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>grpc-stub<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.52.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span> <span class="c">&lt;!-- necessary for Java 9+ --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>annotations-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>6.0.53<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;extensions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;extension&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>kr.motd.maven<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>os-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>1.7.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/extension&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/extensions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.xolstice.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>protobuf-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>0.6.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;protocArtifact&gt;</span>com.google.protobuf:protoc:3.21.7:exe:${os.detected.classifier}<span class="nt">&lt;/protocArtifact&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;pluginId&gt;</span>grpc-java<span class="nt">&lt;/pluginId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;pluginArtifact&gt;</span>io.grpc:protoc-gen-grpc-java:1.52.1:exe:${os.detected.classifier}<span class="nt">&lt;/pluginArtifact&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;executions&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;execution&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;goals&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;goal&gt;</span>compile<span class="nt">&lt;/goal&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;goal&gt;</span>compile-custom<span class="nt">&lt;/goal&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/goals&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/execution&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/executions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/build&gt;</span>
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png" title="image-20230308132952661" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230308132952661.png 2x"
            sizes="auto"
            alt="image-20230308132952661">
    </a></figure></p>
<ul>
<li>
<p>xxxx-server 服务端模块的开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">实现业务接口</span> <span class="err">添加具体的功能</span> <span class="err">（</span><span class="n">MyBatis</span><span class="o">+</span><span class="n">MySQL</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceImpl</span> <span class="kd">extends</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceImplBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      1. 接受client提交的参数  request.getParameter()
</span></span></span><span class="line"><span class="cl"><span class="cm">      2. 业务处理 service+dao 调用对应的业务功能。
</span></span></span><span class="line"><span class="cl"><span class="cm">      3. 提供返回值
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1.接受client的请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.业务处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;name parameter &#34;</span><span class="o">+</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.封装响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//3.1 创建相应对象的构造者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.2 填充数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">builder</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="s">&#34;hello method invoke ok&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.3 封装响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">helloResponse</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">responseObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">helloResponse</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">responseObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">创建服务端</span> <span class="err">（</span><span class="n">Netty</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GprcServer1</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1. 绑定端口 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServerBuilder</span> <span class="n">serverBuilder</span> <span class="o">=</span> <span class="n">ServerBuilder</span><span class="o">.</span><span class="na">forPort</span><span class="o">(</span><span class="mi">9000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2. 发布服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">serverBuilder</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloServiceImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//serverBuilder.addService(new UserServiceImpl());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//3. 创建服务对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="n">serverBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">();;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>xxx-client 模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">client</span><span class="err">通过代理对象完成远端对象的调用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GprcClient1</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1 创建通信的管道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2 获得代理对象 stub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceBlockingStub</span> <span class="n">helloService</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//3. 完成RPC调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//3.1 准备参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;sunshuai&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">helloRequest</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//3.1 进行功能rpc调用，获取相应的内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">helloResponse</span> <span class="o">=</span> <span class="n">helloService</span><span class="o">.</span><span class="na">hello</span><span class="o">(</span><span class="n">helloRequest</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">helloResponse</span><span class="o">.</span><span class="na">getResult</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result = &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>注意事项</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">服务端 处理返回值时
</span></span><span class="line"><span class="cl">responseObserver.onNext(helloResponse1);  //通过这个方法 把响应的消息 回传client
</span></span><span class="line"><span class="cl">responseObserver.onCompleted();           //通知client 整个服务结束。底层返回标记 
</span></span><span class="line"><span class="cl">                                          // client就会监听标记 【grpc做的】
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">requestObserver.onNext(helloRequest1);
</span></span><span class="line"><span class="cl">requestObserver.onCompleted();
</span></span></code></pre></div></li>
</ul>
<h6 id="435grpc的四种通信方式" class="headerLink">
    <a href="#435grpc%e7%9a%84%e5%9b%9b%e7%a7%8d%e9%80%9a%e4%bf%a1%e6%96%b9%e5%bc%8f" class="header-mark"></a>4.3.5gRpc的四种通信方式</h6><ul>
<li>
<p>四种通信方式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 简单rpc 一元rpc (Unary RPC)
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 服务端流式RPC   (Server Streaming RPC)
</span></span><span class="line"><span class="cl"><span class="k">3.</span> 客户端流式RPC   (Client Streaming RPC)
</span></span><span class="line"><span class="cl"><span class="k">4.</span> 双向流RPC (Bi-directional Stream RPC)
</span></span></code></pre></div></li>
<li>
<p>简单RPC(一元RPC)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 第一个RPC程序，实际上就是一元RPC
</span></span></code></pre></div><ul>
<li>
<p>特点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">当client发起调用后，提交数据，并且等待 服务端响应。
</span></span><span class="line"><span class="cl">开发过程中，主要采用就是一元RPC的这种通信方式
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png" title="image-20230309153848531" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230309153848531.png 2x"
            sizes="auto"
            alt="image-20230309153848531">
    </a></figure></p>
</li>
<li>
<p>语法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">service</span> <span class="n">HelloService</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">hello</span><span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloResponse</span><span class="p">){}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">hello1</span><span class="p">(</span><span class="n">HelloRequest1</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloResponse1</span><span class="p">){}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>服务端流式RPC</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">一个请求对象，服务端可以回传多个结果对象。
</span></span></code></pre></div><ul>
<li>
<p>特点</p>
<p><figure><a class="lightgallery" href="./RPC-Day1/image-20230309154817840.png" title="image-20230309154817840" data-thumbnail="./RPC-Day1/image-20230309154817840.png">
        <img
            
            loading="lazy"
            src="./RPC-Day1/image-20230309154817840.png"
            srcset="./RPC-Day1/image-20230309154817840.png, ./RPC-Day1/image-20230309154817840.png 1.5x, ./RPC-Day1/image-20230309154817840.png 2x"
            sizes="auto"
            alt="image-20230309154817840">
    </a></figure></p>
</li>
<li>
<p>使用场景</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">client  --------&gt; Server
</span></span><span class="line"><span class="cl">        股票标号
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">-------</span>
</span></span><span class="line"><span class="cl">         <span class="err">某一个时刻的</span> <span class="err">股票的行情</span>
</span></span></code></pre></div></li>
<li>
<p>语法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">service HelloService{
</span></span><span class="line"><span class="cl">  rpc hello(HelloRequest) returns (stream HelloResponse){}
</span></span><span class="line"><span class="cl">  rpc hello1(HelloRequest1) returns (HelloResponse1){}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div></li>
<li>
<p>关键代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">服务端</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">c2ss</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1 接受client的请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2 做业务处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;name = &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3 根据业务处理的结果，提供响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="s">&#34;处理的结果 &#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">helloResponse</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">responseObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">helloResponse</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">responseObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="err">客户端</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GprcClient3</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceBlockingStub</span> <span class="n">helloService</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;sunshuai&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">helloRequest</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">helloResponseIterator</span> <span class="o">=</span> <span class="n">helloService</span><span class="o">.</span><span class="na">c2ss</span><span class="o">(</span><span class="n">helloRequest</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">helloResponseIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">helloResponse</span> <span class="o">=</span> <span class="n">helloResponseIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;helloResponse.getResult() = &#34;</span> <span class="o">+</span> <span class="n">helloResponse</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">监听</span> <span class="err">异步方式</span> <span class="err">处理服务端流式</span><span class="n">RPC</span><span class="err">的开发</span>
</span></span><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">api</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">服务端</span> 
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="err">客户端</span> 
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcClient4</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceStub</span> <span class="n">helloService</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;xiaohei&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">helloRequest</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">helloService</span><span class="o">.</span><span class="na">c2ss</span><span class="o">(</span><span class="n">helloRequest</span><span class="o">,</span> <span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//服务端 响应了 一个消息后，需要立即处理的话。把代码写在这个方法中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务端每一次响应的信息 &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//需要把服务端 响应的所有数据 拿到后，在进行业务处理。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务端响应结束 后续可以根据需要 在这里统一处理服务端响应的所有内容&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>客户端流式RPC</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">客户端发送多个请求对象，服务端只返回一个结果
</span></span></code></pre></div><p><figure><a class="lightgallery" href="./RPC-Day1/image-20230310142153479.png" title="image-20230310142153479" data-thumbnail="./RPC-Day1/image-20230310142153479.png">
        <img
            
            loading="lazy"
            src="./RPC-Day1/image-20230310142153479.png"
            srcset="./RPC-Day1/image-20230310142153479.png, ./RPC-Day1/image-20230310142153479.png 1.5x, ./RPC-Day1/image-20230310142153479.png 2x"
            sizes="auto"
            alt="image-20230310142153479">
    </a></figure></p>
<ul>
<li>
<p>应用场景</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">IOT(物联网 【传感器】) 向服务端 发送数据
</span></span></code></pre></div></li>
<li>
<p>proto</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="k">rpc</span> <span class="n">cs2s</span><span class="p">(</span><span class="n">stream</span> <span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloResponse</span><span class="p">){}</span><span class="err">
</span></span></span></code></pre></div></li>
<li>
<p>开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">api</span>
</span></span><span class="line"><span class="cl">   <span class="n">rpc</span> <span class="nf">cs2s</span><span class="o">(</span><span class="n">stream</span> <span class="n">HelloRequest</span><span class="o">)</span> <span class="n">returns</span> <span class="o">(</span><span class="n">HelloResponse</span><span class="o">){}</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">服务端开发</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;</span> <span class="nf">cs2s</span><span class="o">(</span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;接受到了client发送一条消息 &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;client的所有消息 都发送到了 服务端 ....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">//提供响应：响应的目的：当接受了全部client提交的信息，并处理后，提供相应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">builder</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="s">&#34;this is result&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">helloResponse</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">responseObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">helloResponse</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">responseObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="err">客户端开发</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcClient5</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceStub</span> <span class="n">helloService</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;</span> <span class="n">helloRequestStreamObserver</span> <span class="o">=</span> <span class="n">helloService</span><span class="o">.</span><span class="na">cs2s</span><span class="o">(</span><span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 监控响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务端 响应 数据内容为 &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务端响应结束 ... &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//客户端 发送数据 到服务端  多条数据 ，不定时...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">builder</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;sunshuai &#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">helloRequest</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">helloRequestStreamObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">helloRequest</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">helloRequestStreamObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>双向流式RPC</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">客户端可以发送多个请求消息，服务端响应多个响应消息
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png" title="image-20230310151339486" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230310151339486.png 2x"
            sizes="auto"
            alt="image-20230310151339486">
    </a></figure></p>
<ul>
<li>
<p>应用场景</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">聊天室
</span></span></code></pre></div></li>
<li>
<p>编码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">api</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc</span> <span class="nf">cs2ss</span><span class="o">(</span><span class="n">stream</span> <span class="n">HelloRequest</span><span class="o">)</span> <span class="n">returns</span> <span class="o">(</span><span class="n">stream</span> <span class="n">HelloResponse</span><span class="o">){}</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">服务端</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;</span> <span class="nf">cs2ss</span><span class="o">(</span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                 <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;接受到client 提交的消息 &#34;</span><span class="o">+</span><span class="n">value</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                 <span class="n">responseObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setResult</span><span class="o">(</span><span class="s">&#34;response &#34;</span><span class="o">+</span><span class="n">value</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">&#34; result &#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                 <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;接受到了所有的请求消息 ... &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                 <span class="n">responseObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="err">客户端</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcClient6</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceStub</span> <span class="n">helloService</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">&gt;</span> <span class="n">helloRequestStreamObserver</span> <span class="o">=</span> <span class="n">helloService</span><span class="o">.</span><span class="na">cs2ss</span><span class="o">(</span><span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应的结果 &#34;</span><span class="o">+</span><span class="n">value</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应全部结束...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">helloRequestStreamObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;sunshuai &#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">helloRequestStreamObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h6 id="436-gprc代理方式" class="headerLink">
    <a href="#436-gprc%e4%bb%a3%e7%90%86%e6%96%b9%e5%bc%8f" class="header-mark"></a>4.3.6 gPRC代理方式</h6><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> BlockingStub
</span></span><span class="line"><span class="cl">   阻塞 通信方式 
</span></span><span class="line"><span class="cl"><span class="k">2.</span> Stub
</span></span><span class="line"><span class="cl">   异步 通过监听处理的
</span></span><span class="line"><span class="cl"><span class="k">3.</span> FutureStub
</span></span><span class="line"><span class="cl">   同步 异步 NettyFuture
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> FutureStub只能应用 一元RPC 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcClient7</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">usePlaintext</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TestServiceGrpc</span><span class="o">.</span><span class="na">TestServiceFutureStub</span> <span class="n">testServiceFutureStub</span> <span class="o">=</span> <span class="n">TestServiceGrpc</span><span class="o">.</span><span class="na">newFutureStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">TestProto</span><span class="o">.</span><span class="na">TestResponse</span><span class="o">&gt;</span> <span class="n">responseListenableFuture</span> <span class="o">=</span> <span class="n">testServiceFutureStub</span><span class="o">.</span><span class="na">testSuns</span><span class="o">(</span><span class="n">TestProto</span><span class="o">.</span><span class="na">TestRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;xiaojren&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* 同步操作
</span></span></span><span class="line"><span class="cl"><span class="cm">            TestProto.TestResponse testResponse = responseListenableFuture.get();
</span></span></span><span class="line"><span class="cl"><span class="cm">            System.out.println(testResponse.getResult());*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="cm">/*  responseListenableFuture.addListener(() -&gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm">                System.out.println(&#34;异步的rpc响应 回来了....&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">            }, Executors.newCachedThreadPool());*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Futures</span><span class="o">.</span><span class="na">addCallback</span><span class="o">(</span><span class="n">responseListenableFuture</span><span class="o">,</span> <span class="k">new</span> <span class="n">FutureCallback</span><span class="o">&lt;</span><span class="n">TestProto</span><span class="o">.</span><span class="na">TestResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">TestProto</span><span class="o">.</span><span class="na">TestResponse</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result.getResult() = &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;后续的操作....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="5-gprc与springboot整合" class="headerLink">
    <a href="#5-gprc%e4%b8%8espringboot%e6%95%b4%e5%90%88" class="header-mark"></a>5. gPRC与SpringBoot整合</h4><h5 id="51-grpc和springboot整合的思想" class="headerLink">
    <a href="#51-grpc%e5%92%8cspringboot%e6%95%b4%e5%90%88%e7%9a%84%e6%80%9d%e6%83%b3" class="header-mark"></a>5.1 gRPC和SpringBoot整合的思想</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> grpc-server
</span></span><span class="line"><span class="cl"><span class="k">2.</span> grpc-client 
</span></span></code></pre></div><h6 id="springboot与grpc整合的过程中-对于服务端做了什么封装" class="headerLink">
    <a href="#springboot%e4%b8%8egrpc%e6%95%b4%e5%90%88%e7%9a%84%e8%bf%87%e7%a8%8b%e4%b8%ad-%e5%af%b9%e4%ba%8e%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88%e5%b0%81%e8%a3%85" class="header-mark"></a>SpringBoot与GRPC整合的过程中 对于服务端做了什么封装</h6><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png" title="image-20230312191718736" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230312191718736.png 2x"
            sizes="auto"
            alt="image-20230312191718736">
    </a></figure></p>
<ul>
<li>
<p>搭建开发环境</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 搭建SpringBoot的开发环境
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 引入与Grpc相关的内容
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">groupId</span><span class="p">&gt;</span>com.suns<span class="p">&lt;/</span><span class="nt">groupId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">artifactId</span><span class="p">&gt;</span>rpc-grpc-api<span class="p">&lt;/</span><span class="nt">artifactId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">version</span><span class="p">&gt;</span>1.0-SNAPSHOT<span class="p">&lt;/</span><span class="nt">version</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="p">&lt;/</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">groupId</span><span class="p">&gt;</span>net.devh<span class="p">&lt;/</span><span class="nt">groupId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">artifactId</span><span class="p">&gt;</span>grpc-server-spring-boot-starter<span class="p">&lt;/</span><span class="nt">artifactId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">version</span><span class="p">&gt;</span>2.14.0.RELEASE<span class="p">&lt;/</span><span class="nt">version</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>开发服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 重复 多次 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@GrpcService</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceImpl</span> <span class="kd">extends</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceImplBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;name is &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">responseObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setResult</span><span class="o">(</span><span class="s">&#34;this is result&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">responseObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// application.yml
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">#</span> <span class="err">核心配置的</span> <span class="err">就是</span><span class="n">gRPC</span><span class="err">服务的端口号</span>
</span></span><span class="line"><span class="cl"><span class="nl">spring:</span>
</span></span><span class="line"><span class="cl">  <span class="n">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">:</span> <span class="n">boot</span><span class="o">-</span><span class="n">server</span>
</span></span><span class="line"><span class="cl"><span class="nl">
</span></span></span><span class="line"><span class="cl"><span class="nl">  main:</span>
</span></span><span class="line"><span class="cl">    <span class="n">web</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">none</span>
</span></span><span class="line"><span class="cl"><span class="nl">
</span></span></span><span class="line"><span class="cl"><span class="nl">grpc:</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span><span class="o">:</span> <span class="mi">9000</span>
</span></span></code></pre></div></li>
<li>
<p>客户端</p>
<p>环境搭建</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"> <span class="p">&lt;</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">groupId</span><span class="p">&gt;</span>net.devh<span class="p">&lt;/</span><span class="nt">groupId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">artifactId</span><span class="p">&gt;</span>grpc-client-spring-boot-starter<span class="p">&lt;/</span><span class="nt">artifactId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">version</span><span class="p">&gt;</span>2.14.0.RELEASE<span class="p">&lt;/</span><span class="nt">version</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="p">&lt;/</span><span class="nt">dependency</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>编码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> yml
</span></span><span class="line"><span class="cl">grpc:
</span></span><span class="line"><span class="cl">  client:
</span></span><span class="line"><span class="cl">    grpc-server:
</span></span><span class="line"><span class="cl">      address: &#39;static://127.0.0.1:9000&#39;
</span></span><span class="line"><span class="cl">      negotiation-type: plaintext
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 注入stub
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ni">@GrpcClient</span>(&#34;grpc-server&#34;)
</span></span><span class="line"><span class="cl">private HelloServiceGrpc.HelloServiceBlockingStub stub;
</span></span></code></pre></div></li>
</ul>
<h4 id="6-gprc的高级应用" class="headerLink">
    <a href="#6-gprc%e7%9a%84%e9%ab%98%e7%ba%a7%e5%ba%94%e7%94%a8" class="header-mark"></a>6. gPRC的高级应用</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 拦截器  一元拦截器 
</span></span><span class="line"><span class="cl"><span class="k">2.</span> Stream Tracer [监听流]  流拦截器 
</span></span><span class="line"><span class="cl"><span class="k">3.</span> Retry Policy 客户端重试 
</span></span><span class="line"><span class="cl"><span class="k">4.</span> NameResolver 
</span></span><span class="line"><span class="cl"><span class="k">5.</span> 负载均衡 （pick-first , 轮训）
</span></span><span class="line"><span class="cl"><span class="k">6.</span> grpc与微服务的整合 
</span></span><span class="line"><span class="cl">   序列化 （protobuf) Dobbo
</span></span><span class="line"><span class="cl">   grpc              Dobbo
</span></span><span class="line"><span class="cl">   grpc              GateWay
</span></span><span class="line"><span class="cl">   grpc              JWT
</span></span><span class="line"><span class="cl">   grpc              Nacos2.0
</span></span><span class="line"><span class="cl">   grpc              OpenFeign 
</span></span></code></pre></div><h5 id="61-拦截器" class="headerLink">
    <a href="#61-%e6%8b%a6%e6%88%aa%e5%99%a8" class="header-mark"></a>6.1 拦截器</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 拦截器的作用
</span></span><span class="line"><span class="cl">   鉴权 ，数据校验 ，限流...
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 常见的拦截器 
</span></span><span class="line"><span class="cl">   web        Filter
</span></span><span class="line"><span class="cl">   springmvc  Interceptor 
</span></span><span class="line"><span class="cl">   SS         Filter
</span></span><span class="line"><span class="cl">   Netty      handler
</span></span><span class="line"><span class="cl"><span class="k">3.</span> gRPC的拦截器 
</span></span><span class="line"><span class="cl">   <span class="k">1.</span>  一元请求的 拦截器 
</span></span><span class="line"><span class="cl">       客户端 【请求 响应】
</span></span><span class="line"><span class="cl">       服务端 【请求 响应】
</span></span><span class="line"><span class="cl">   <span class="k">2.</span>  流式请求的 拦截器  （Stream Tracer)
</span></span><span class="line"><span class="cl">       客户端 【请求 响应】
</span></span><span class="line"><span class="cl">       服务端 【请求 响应】
</span></span></code></pre></div><h6 id="611-一元拦截器" class="headerLink">
    <a href="#611-%e4%b8%80%e5%85%83%e6%8b%a6%e6%88%aa%e5%99%a8" class="header-mark"></a>6.1.1 一元拦截器</h6><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png" title="image-20230316112142470" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230316112142470.png 2x"
            sizes="auto"
            alt="image-20230316112142470">
    </a></figure></p>
<ul>
<li>
<p>简单客户端拦截器的开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//1 开发拦截器 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomClientInterceptor</span> <span class="kd">implements</span> <span class="n">ClientInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">MethodDescriptor</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="n">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="n">Channel</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;这是一个拦截启动的处理 ,统一的做了一些操作 ....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//2 在客户端进行设置 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">usePlaintext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomClientInterceptor</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="err">细节：</span>
</span></span><span class="line"><span class="cl">  <span class="n">usePlaintext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">intercept</span><span class="o">(</span><span class="err">）</span>
</span></span><span class="line"><span class="cl">  <span class="err">调用的先后顺序没有必须关联，谁先谁后都行。</span>
</span></span></code></pre></div></li>
<li>
<p>简单客户端拦截器问题</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 只能拦截请求，不能拦截响应。
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 即使拦截了请求操作，粒度业务过于宽泛，不精准。
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 开始阶段 2. 设置消息数量 3.发送数据阶段 4.半连接阶段。
</span></span></code></pre></div></li>
<li>
<p>复杂客户端拦截器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">拦截请求，拦截响应。</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">分阶段的进行</span> <span class="err">请求</span> <span class="err">响应的拦截</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">渗透的</span> <span class="n">ClientCall</span><span class="o">[</span><span class="err">方法</span><span class="o">]</span>  <span class="err">装饰器设计模式</span> <span class="err">典型的使用场景。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomClientInterceptor</span> <span class="kd">implements</span> <span class="n">ClientInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">MethodDescriptor</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="n">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="n">Channel</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;这是一个拦截启动的处理 ,统一的做了一些操作 ....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">           如果我们需要用复杂客户端拦截器 ，就需要对原始的ClientCall进行包装
</span></span></span><span class="line"><span class="cl"><span class="cm">           那么这个时候，就不能反悔原始ClientCall对象，
</span></span></span><span class="line"><span class="cl"><span class="cm">           应该返回 包装的ClientCall ---&gt; CustomForwardingClientClass
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//return next.newCall(method, callOptions);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomForwardingClientClass</span><span class="o">&lt;&gt;(</span><span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">   这个类型 适用于控制 拦截 请求发送各个环节
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomForwardingClientClass</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ClientInterceptors</span><span class="o">.</span><span class="na">CheckedForwardingClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">CustomForwardingClientClass</span><span class="o">(</span><span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//开始调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 目的 看一个这个RPC请求是不是可以被发起。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkedStart</span><span class="o">(</span><span class="n">Listener</span><span class="o">&lt;</span><span class="n">RespT</span><span class="o">&gt;</span> <span class="n">responseListener</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;发送请求数据之前的检查.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//真正的去发起grpc的请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 是否真正发送grpc的请求，取决这个start方法的调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//delegate().start(responseListener, headers);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">delegate</span><span class="o">().</span><span class="na">start</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomCallListener</span><span class="o">&lt;&gt;(</span><span class="n">responseListener</span><span class="o">),</span> <span class="n">headers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//指定发送消息的数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">(</span><span class="kt">int</span> <span class="n">numMessages</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//添加一些功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;request 方法被调用 ....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">numMessages</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//发送消息 缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">ReqT</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;sendMessage 方法被调用... {} &#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//开启半连接 请求消息无法发送，但是可以接受响应的消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">halfClose</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;halfClose 方法被调用... 开启了半连接&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">halfClose</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">   用于监听响应，并对响应进行拦截
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomCallListener</span><span class="o">&lt;</span><span class="n">RespT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ForwardingClientCallListener</span><span class="o">.</span><span class="na">SimpleForwardingClientCallListener</span><span class="o">&lt;</span><span class="n">RespT</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">CustomCallListener</span><span class="o">(</span><span class="n">ClientCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">RespT</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onHeaders</span><span class="o">(</span><span class="n">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;响应头信息 回来了......&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">RespT</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;响应的数据 回来了.....{} &#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">onHeaders</span><span class="err">这个方法</span> <span class="err">会在</span><span class="n">onNext</span><span class="err">调用后</span> <span class="err">监听到数据</span>
</span></span><span class="line"><span class="cl"><span class="n">onMessage</span><span class="err">这个方法</span> <span class="err">会在</span><span class="n">onCompleted</span><span class="err">调用后</span> <span class="err">监听到数据</span>
</span></span></code></pre></div></li>
<li>
<p>简单服务端拦截器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServerInterceptor</span> <span class="kd">implements</span> <span class="n">ServerInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ServerCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">ServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">,</span> <span class="n">ServerCallHandler</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//在服务器端 拦截请求操作的功能 写在这个方法中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;服务器端拦截器生效.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="na">startCall</span><span class="o">(</span><span class="n">call</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServerBuilder</span><span class="o">&lt;?&gt;</span> <span class="n">serverBuilder</span> <span class="o">=</span> <span class="n">ServerBuilder</span><span class="o">.</span><span class="na">forPort</span><span class="o">(</span><span class="mi">9000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverBuilder</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloServiceImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverBuilder</span><span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomServerInterceptor</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="n">serverBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>简单服务端拦截器问题</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 拦截请求发送过来的数据，无法处理响应的数据
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 拦截力度过于宽泛
</span></span></code></pre></div></li>
<li>
<p>复杂服务端拦截器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 拦截请求的数据，拦截响应的数据
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 粒度细致
</span></span></code></pre></div><ul>
<li>
<p>请求数据的拦截</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServerInterceptor</span> <span class="kd">implements</span> <span class="n">ServerInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ServerCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">ServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">,</span> <span class="n">ServerCallHandler</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//在服务器端 拦截请求操作的功能 写在这个方法中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;服务器端拦截器生效.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//默认返回的ServerCall.Listener仅仅能够完成请求数据的监听，单没有拦截功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//所以要做扩展，采用包装器设计模式。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//return next.startCall(call, headers);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomServerCallListener</span><span class="o">&lt;&gt;(</span><span class="n">next</span><span class="o">.</span><span class="na">startCall</span><span class="o">(</span><span class="n">call</span><span class="o">,</span> <span class="n">headers</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomServerCallListener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ForwardingServerCallListener</span><span class="o">.</span><span class="na">SimpleForwardingServerCallListener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">CustomServerCallListener</span><span class="o">(</span><span class="n">ServerCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//准备接受请求数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReady</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;onRead Method Invoke....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onReady</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">ReqT</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;接受到了 请求提交的数据  {} &#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onHalfClose</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;监听到了 半连接...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onHalfClose</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;服务端 onCompleted()...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCancel</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;出现异常后 会调用这个方法... 关闭资源的操作&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onCancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>拦截响应</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">目的：通过自定义的</span><span class="n">ServerCall</span> <span class="err">包装原始的</span><span class="n">ServerCall</span> <span class="err">增加对于响应拦截的功能</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ForwardingServerCall</span><span class="o">.</span><span class="na">SimpleForwardingServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">CustomServerCall</span><span class="o">(</span><span class="n">ServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//指定发送消息的数量 【响应消息】
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">(</span><span class="kt">int</span> <span class="n">numMessages</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;response 指定消息的数量 【request】&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">numMessages</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置响应头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendHeaders</span><span class="o">(</span><span class="n">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;response 设置响应头 【sendHeaders】&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">sendHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//响应数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">RespT</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;response 响应数据  【send Message 】 {} &#34;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//关闭连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">Status</span> <span class="n">status</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">trailers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;respnse 关闭连接 【close】&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">trailers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">目的：就是把自定义的</span><span class="n">ServerCall</span><span class="err">与</span><span class="n">gRpc</span><span class="err">服务端进行整合</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServerInterceptor</span> <span class="kd">implements</span> <span class="n">ServerInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ServerCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">ServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">,</span> <span class="n">ServerCallHandler</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//在服务器端 拦截请求操作的功能 写在这个方法中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;服务器端拦截器生效.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//1. 包装ServerCall 处理服务端响应拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CustomServerCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span><span class="n">RespT</span><span class="o">&gt;</span> <span class="n">reqTRespTCustomServerCall</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomServerCall</span><span class="o">&lt;&gt;(</span><span class="n">call</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2. 包装Listener   处理服务端请求拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CustomServerCallListener</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">&gt;</span> <span class="n">reqTCustomServerCallListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomServerCallListener</span><span class="o">&lt;&gt;(</span><span class="n">next</span><span class="o">.</span><span class="na">startCall</span><span class="o">(</span><span class="n">reqTRespTCustomServerCall</span><span class="o">,</span> <span class="n">headers</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">reqTCustomServerCallListener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h6 id="612-流式拦截器" class="headerLink">
    <a href="#612-%e6%b5%81%e5%bc%8f%e6%8b%a6%e6%88%aa%e5%99%a8" class="header-mark"></a>6.1.2 流式拦截器</h6><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">主要应用 gRPC除了 一元RPC之外的其他形式RPC操作的拦截工作
</span></span><span class="line"><span class="cl"><span class="k">1.</span> 服务端流式RPC
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 客户端流式RPC
</span></span><span class="line"><span class="cl"><span class="k">3.</span> 双向流式RPC
</span></span></code></pre></div><ul>
<li>
<p>一元通信方式 和 流式通信方式的区别</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">对比 一元通信方式，流式通信方式的特点是消息多，而且不是一次性通信，是分批分期。这个时候一元拦截器就无法细粒度的拦截特定的消息。
</span></span><span class="line"><span class="cl">所以需要流式拦截器 解决这个问题。流式拦截器【Stream Tracer】
</span></span></code></pre></div></li>
<li>
<p>客户端流式拦截器的开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 拦截请求  拦截响应
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 开发思路 
</span></span><span class="line"><span class="cl">   ClientStreamTracer [拦截请求 拦截响应]
</span></span><span class="line"><span class="cl">   ClientStreamTracerFactory 
</span></span><span class="line"><span class="cl">      目的 就是用于创建ClientStreamTracer.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerClientInterceptor</span> <span class="kd">implements</span> <span class="n">ClientInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">MethodDescriptor</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="n">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="n">Channel</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;执行客户端拦截器...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//把自己开发的ClientStreamTracerFactory融入到gRPC体系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">callOptions</span> <span class="o">=</span> <span class="n">callOptions</span><span class="o">.</span><span class="na">withStreamTracerFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomClientStreamTracerFactory</span><span class="o">&lt;&gt;());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomClientStreamTracerFactory</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ClientStreamTracer</span><span class="o">.</span><span class="na">Factory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ClientStreamTracer</span> <span class="nf">newClientStreamTracer</span><span class="o">(</span><span class="n">ClientStreamTracer</span><span class="o">.</span><span class="na">StreamInfo</span> <span class="n">info</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomClientStreamTracer</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> 作用： 用于客户端流式拦截：拦截请求 拦截响应
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomClientStreamTracer</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ClientStreamTracer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//outbound 对于请求相关操作的拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//用于输出响应头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundHeaders</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;client: 用于输出请求头.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundHeaders</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置消息编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;client: 设置流消息的编号 {} &#34;</span><span class="o">,</span> <span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundMessage</span><span class="o">(</span><span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundUncompressedSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;client: 获得未压缩消息的大小 {} &#34;</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundUncompressedSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//用于获得 输出消息的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundWireSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;client: 用于获得 输出消息的大小 {} &#34;</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundWireSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//拦截消息发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundMessageSent</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalUncompressedSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;client: 监控请求操作 outboundMessageSent {} &#34;</span><span class="o">,</span> <span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundMessageSent</span><span class="o">(</span><span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//inbound  对于相应相关操作的拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundHeaders</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;用于获得响应头....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundHeaders</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;获得响应消息的编号...{} &#34;</span><span class="o">,</span><span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundMessage</span><span class="o">(</span><span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundWireSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;获得响应消息的大小...{} &#34;</span><span class="o">,</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundWireSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundMessageRead</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalUncompressedSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;集中获得消息的编号 ，大小 ，未压缩大小 {} {} {}&#34;</span><span class="o">,</span> <span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundMessageRead</span><span class="o">(</span><span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundUncompressedSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;获得响应消息未压缩大小 {} &#34;</span><span class="o">,</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundUncompressedSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundTrailers</span><span class="o">(</span><span class="n">Metadata</span> <span class="n">trailers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;响应结束..&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundTrailers</span><span class="o">(</span><span class="n">trailers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>服务端流式拦截器的开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> ServerStreamTracer 拦截
</span></span><span class="line"><span class="cl">   inbound  请求的拦截
</span></span><span class="line"><span class="cl">   outbound 响应的拦截 
</span></span><span class="line"><span class="cl"><span class="k">2.</span> ServerStreamTracerFactory进行创建
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServerStreamFactory</span> <span class="kd">extends</span> <span class="n">ServerStreamTracer</span><span class="o">.</span><span class="na">Factory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ServerStreamTracer</span> <span class="nf">newServerStreamTracer</span><span class="o">(</span><span class="n">String</span> <span class="n">fullMethodName</span><span class="o">,</span> <span class="n">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomServerStreamTracer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomServerStreamTracer</span> <span class="kd">extends</span> <span class="n">ServerStreamTracer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//inbound 拦截请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundMessage</span><span class="o">(</span><span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundWireSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundWireSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundMessageRead</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalUncompressedSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;server: 获得client发送的请求消息 ...{} {} {}&#34;</span><span class="o">,</span> <span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundMessageRead</span><span class="o">(</span><span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inboundUncompressedSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">inboundUncompressedSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//outbound 拦截请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundMessage</span><span class="o">(</span><span class="n">seqNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundMessageSent</span><span class="o">(</span><span class="kt">int</span> <span class="n">seqNo</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">optionalUncompressedSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;server: 响应数据的拦截 ...{} {} {}&#34;</span><span class="o">,</span> <span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundMessageSent</span><span class="o">(</span><span class="n">seqNo</span><span class="o">,</span> <span class="n">optionalWireSize</span><span class="o">,</span> <span class="n">optionalUncompressedSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundWireSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundWireSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outboundUncompressedSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">outboundUncompressedSize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">serverBuilder</span><span class="o">.</span><span class="na">addStreamTracerFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomServerStreamFactory</span><span class="o">());</span>
</span></span></code></pre></div></li>
</ul>
<h5 id="62-客户端重试" class="headerLink">
    <a href="#62-%e5%ae%a2%e6%88%b7%e7%ab%af%e9%87%8d%e8%af%95" class="header-mark"></a>6.2 客户端重试</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">客户端重试保证了系统可靠性。
</span></span><span class="line"><span class="cl">在RGPC调用过程中看，因为网络延迟 或者抖动，可能操作客户端暂时链接不上服务端的情况，如果出现了此类情况的话。那么可以让client重试连接。尽可能的避免，因为网络问题，影响通信。从而保证了系统的可靠性。
</span></span></code></pre></div><ul>
<li>
<p>开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">服务端</span> 
</span></span><span class="line"><span class="cl">   <span class="err">模拟网络问题</span> 
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">客户端</span>
</span></span><span class="line"><span class="cl">   <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;methodConfig&#34;</span><span class="o">:</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;name&#34;</span><span class="o">:</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;service&#34;</span><span class="o">:</span> <span class="s">&#34;com.suns.HelloService&#34;</span><span class="o">,</span> <span class="c1">//服务的名字 包名 package
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="s">&#34;method&#34;</span><span class="o">:</span> <span class="s">&#34;hello&#34;</span>  <span class="c1">//服务方法名字 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">],</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;retryPolicy&#34;</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;maxAttempts&#34;</span><span class="o">:</span> <span class="mi">3</span><span class="o">,</span>         <span class="c1">//重试的次数 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="s">&#34;initialBackoff&#34;</span><span class="o">:</span> <span class="s">&#34;0.5s&#34;</span><span class="o">,</span> <span class="c1">//初始重试的延迟时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="s">&#34;maxBackof&#34;</span><span class="o">:</span> <span class="s">&#34;30s&#34;</span><span class="o">,</span>       <span class="c1">//最大重试的延迟时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="s">&#34;backoffMultiplier&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="o">,</span>   <span class="c1">//退避指数 每一次重试的时间间隔，不是不固定，2 4 6...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="s">&#34;retryableStatusCodes&#34;</span><span class="o">:</span> <span class="o">[</span> <span class="c1">//只有当接受到了这个数组中描述的异常，才会发起重试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="s">&#34;UNAVAILABLE&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">9000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">usePlaintext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultServiceConfig</span><span class="o">(</span><span class="n">serviceConfig</span><span class="o">)</span> <span class="c1">//设置重试的参数 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">enableRetry</span><span class="o">()</span>  <span class="c1">//打开重试 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span></code></pre></div></li>
</ul>
<h5 id="63-命名解析-nameresovler" class="headerLink">
    <a href="#63-%e5%91%bd%e5%90%8d%e8%a7%a3%e6%9e%90-nameresovler" class="header-mark"></a>6.3 命名解析 NameResovler</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 什么是命名解析
</span></span><span class="line"><span class="cl">   本质上就是我们在SOA或者微服务中，所说的注册中心。
</span></span><span class="line"><span class="cl"><span class="k">2.</span> 为什么需要注册中心(名字解析）？
</span></span><span class="line"><span class="cl">   rpc集群环境下，通过注册中心（名字解析）统一管理rpc集群 【负载均衡，监控检查....】
</span></span><span class="line"><span class="cl"><span class="k">3.</span> 目前开发中 常见注册中心 
</span></span><span class="line"><span class="cl">   Dubbo         zookeeper 
</span></span><span class="line"><span class="cl">   SpringCloud   eureka nacos consul etcd ...  
</span></span><span class="line"><span class="cl"><span class="k">4.</span> gRPC 名字解析 注册中心 
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 默认gPRC是通过DNS 做注册中心。
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 可以用户自定义注册中心 （扩展）
</span></span><span class="line"><span class="cl"><span class="k">5.</span> 如何进行gRPC注册中心的扩展 【重点】
</span></span><span class="line"><span class="cl">              zk     etcd   consul 
</span></span><span class="line"><span class="cl">   开发语言    java    go     go
</span></span><span class="line"><span class="cl">   算法       Paxos   Raft   Raft
</span></span><span class="line"><span class="cl">   多数据中心  不支持   不支持  支持 
</span></span><span class="line"><span class="cl">   web管理    支持     不支持  支持
</span></span><span class="line"><span class="cl">   ....
</span></span></code></pre></div><p><figure><a class="lightgallery" href="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png" title="image-20230319203204763" data-thumbnail="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png">
        <img
            
            loading="lazy"
            src="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png"
            srcset="/Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png 1.5x, /Users/shengquan/my_website/content/posts/gRPC.assets/image-20230319203204763.png 2x"
            sizes="auto"
            alt="image-20230319203204763">
    </a></figure></p>
<h6 id="631-consul" class="headerLink">
    <a href="#631-consul" class="header-mark"></a>6.3.1 Consul</h6><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> Consul是什么？
</span></span><span class="line"><span class="cl">   HashiCorp公司开源一个工具，用于实现分布式系统中服务发现（注册）与配置。nacos
</span></span><span class="line"><span class="cl">   https://www.consul.io/
</span></span><span class="line"><span class="cl">   一站式的解决方案，内置注册中心，健康检查，多数据中心，KeyValue存储。。。
</span></span><span class="line"><span class="cl"><span class="k">2.</span> Consul作用：
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 注册中心
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 配置中心 
</span></span><span class="line"><span class="cl"><span class="k">3.</span> 使用Consul的好处 
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 安装简单 ---》自带web管理界面 
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 使用方便 比如 健康检查
</span></span><span class="line"><span class="cl">   <span class="k">3.</span> 一致性算法 Raft..
</span></span><span class="line"><span class="cl"><span class="k">4.</span> Consul的安装
</span></span><span class="line"><span class="cl">   官网下载对应版本的内容，解压缩
</span></span><span class="line"><span class="cl">   终端【cmd】./consul agent -dev
</span></span></code></pre></div><h6 id="632-consul-java客户端开发注册中心" class="headerLink">
    <a href="#632-consul-java%e5%ae%a2%e6%88%b7%e7%ab%af%e5%bc%80%e5%8f%91%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" class="header-mark"></a>6.3.2 Consul Java客户端开发注册中心</h6><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">服务注册的本质：</span><span class="n">consul</span><span class="err">进行服务注册时，不关心服务的名字</span> <span class="err">服务的功能</span> <span class="err">做什么。</span><span class="n">ip</span><span class="o">+</span><span class="n">port</span> 
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">一个</span><span class="n">gprc</span><span class="err">功能的集群</span> <span class="err">定义一个逻辑的名字</span> 
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="n">consul</span><span class="err">会自己进行健康检查：本质</span> <span class="err">我们提供的这个服务的</span><span class="n">ip</span><span class="o">+</span><span class="n">port</span><span class="err">是不是可以通信。</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Consul</span> <span class="n">Java</span><span class="err">客户端</span> <span class="err">进行注册中心服务端的开发</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1 模拟服务  localhost:9000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServerSocketChannel</span> <span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">65535</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2 consul java client进行注册服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 连接到consul服务器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Consul</span> <span class="n">consulConnection</span> <span class="o">=</span> <span class="n">Consul</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获得consul客户端对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AgentClient</span> <span class="n">agentClient</span> <span class="o">=</span> <span class="n">consulConnection</span><span class="o">.</span><span class="na">agentClient</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">serviceId</span> <span class="o">=</span> <span class="s">&#34;Server-&#34;</span> <span class="o">+</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 进行服务的注册
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Registration</span> <span class="n">service</span> <span class="o">=</span> <span class="n">ImmutableRegistration</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;grpc-server&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">serviceId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="n">port</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">tags</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">meta</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">,</span> <span class="s">&#34;1.0&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ttl http tcp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 通过tpc的方式进行健康检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="n">Registration</span><span class="o">.</span><span class="na">RegCheck</span><span class="o">.</span><span class="na">tcp</span><span class="o">(</span><span class="s">&#34;localhost:&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">agentClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="err">删除一个失效的服务</span>
</span></span><span class="line"><span class="cl"> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:8500/v1/agent/service/deregister/Server-b37769f1-8422-4919-b3a7-c1235d1cdc22 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">健康检查</span>
</span></span><span class="line"><span class="cl">  <span class="n">Registration</span><span class="o">.</span><span class="na">RegCheck</span><span class="o">.</span><span class="na">tcp</span><span class="o">(</span><span class="s">&#34;localhost:&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">如果不做健康检查，那么</span><span class="n">consul</span><span class="err">是无法确定服务是否存活。</span>
</span></span><span class="line"><span class="cl">  <span class="err">底层</span> <span class="err">开了新的线程</span> <span class="err">通过延迟队列的方式</span> <span class="err">与</span> <span class="err">对应的</span><span class="n">ip</span><span class="o">+</span><span class="n">port</span><span class="err">进行通信。</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Consul</span> <span class="n">Java</span><span class="err">客户端</span> <span class="err">进行注册中心客户端的开发</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="err">根据集群的名字（服务的名字）</span> <span class="err">获得</span> <span class="err">一组健康的服务。根据负载均衡的算法，获取实际通信的</span><span class="n">rpc</span><span class="err">进行调用</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestClient</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Consul</span> <span class="n">consulConnection</span> <span class="o">=</span> <span class="n">Consul</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">HealthClient</span> <span class="n">healthClient</span> <span class="o">=</span> <span class="n">consulConnection</span><span class="o">.</span><span class="na">healthClient</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ConsulResponse</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceHealth</span><span class="o">&gt;&gt;</span> <span class="n">allServiceInstances</span> <span class="o">=</span> <span class="n">healthClient</span><span class="o">.</span><span class="na">getHealthyServiceInstances</span><span class="o">(</span><span class="s">&#34;grpc-server&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceHealth</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">allServiceInstances</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">ServiceHealth</span> <span class="n">serviceHealth</span> <span class="o">:</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;serviceHealth.getService() = &#34;</span> <span class="o">+</span> <span class="n">serviceHealth</span><span class="o">.</span><span class="na">getService</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">获取健康实例的时候，</span><span class="n">consul</span><span class="err">有可能同步不准确。</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">由负载均衡决定</span> <span class="err">客户端访问那个服务。【客户端负载均衡】</span> 
</span></span></code></pre></div><h6 id="633-grpc中consul注册中心的开发" class="headerLink">
    <a href="#633-grpc%e4%b8%adconsul%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e7%9a%84%e5%bc%80%e5%8f%91" class="header-mark"></a>6.3.3 Grpc中Consul注册中心的开发</h6><ul>
<li>
<p>服务端的处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GrpcServerConsul</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">65535</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ServerBuilder</span><span class="o">&lt;?&gt;</span> <span class="n">serverBuilder</span> <span class="o">=</span> <span class="n">ServerBuilder</span><span class="o">.</span><span class="na">forPort</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverBuilder</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloServiceImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="n">serverBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;server is starting......&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">registerToConsul</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerToConsul</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Consul</span> <span class="n">consul</span> <span class="o">=</span> <span class="n">Consul</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">AgentClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">consul</span><span class="o">.</span><span class="na">agentClient</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">serviceId</span> <span class="o">=</span> <span class="s">&#34;Server-&#34;</span> <span class="o">+</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ImmutableRegistration</span> <span class="n">service</span> <span class="o">=</span> <span class="n">ImmutableRegistration</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">serviceId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;grpc-server&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="n">port</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">tags</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">meta</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">,</span> <span class="s">&#34;1.0&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="n">Registration</span><span class="o">.</span><span class="na">RegCheck</span><span class="o">.</span><span class="na">tcp</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>客户端的处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">1.</span> 客户端在访问具体的grpc服务之前，到命名中心（注册中心 consul）去查找注册的服务。
</span></span><span class="line"><span class="cl">   命名解析 
</span></span><span class="line"><span class="cl">       NameResolver 
</span></span><span class="line"><span class="cl">          根据名字（服务的名字） 去注册中心查找服务，进而进行访问
</span></span><span class="line"><span class="cl">       NameResolverProvider 
</span></span><span class="line"><span class="cl">          作用：命名解析的提供者（工厂），用于创建命名解析对象，完成对于注册中心的访问。
</span></span><span class="line"><span class="cl">   内置的命名解析 
</span></span><span class="line"><span class="cl">       DNS方式处理的注册中心。修改自定义的名字解析的优先级，高于DNS才可以使用consul进行替换。
</span></span><span class="line"><span class="cl"> <span class="k">2.</span> 负载均衡   
</span></span><span class="line"><span class="cl">       grpc客户端内置 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">自定义</span><span class="n">NameResolver</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">自定义</span><span class="n">NameResolverProvider</span>
</span></span></code></pre></div><ul>
<li>
<p>customNameResolver</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomNameResolver</span> <span class="kd">extends</span> <span class="n">NameResolver</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ScheduledThreadPoolExecutor</span> <span class="n">scheduledThreadPoolExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Consul</span> <span class="n">consul</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">authority</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Listener2</span> <span class="n">listener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//用于为authority赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">CustomNameResolver</span><span class="o">(</span><span class="n">String</span> <span class="n">authority</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">authority</span> <span class="o">=</span> <span class="n">authority</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">consul</span> <span class="o">=</span> <span class="n">Consul</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//authority 概念 服务器集群的名字 grpc-server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getServiceAuthority</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">authority</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">       listener 中文 叫做监听
</span></span></span><span class="line"><span class="cl"><span class="cm">       start方法中我们要周期的发起对于名字解析的请求，获取最新的服务列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">Listener2</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">listener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">scheduledThreadPoolExecutor</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">resolve</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//定期完成的工作 就是在resolve中处理的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//完成解析的工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">resolve</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;开始解析 服务.... {} &#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">authority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1  获取所有的健康服务 grpc-server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//把所有的健康服务的 ip+port封装 InetSocketAddress
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">addressList</span> <span class="o">=</span> <span class="n">getAddressList</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">authority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">addressList</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">addressList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;解析存在问题：{} 失败.....&#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">authority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">Status</span><span class="o">.</span><span class="na">UNAVAILABLE</span><span class="o">.</span><span class="na">withDescription</span><span class="o">(</span><span class="s">&#34;没有可用的节点....&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2 负载均衡 gprc 把所健康服务 封装 EquivalentAddressGroup {address:port}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// InetSocketAddress ---&gt; EquivalentAddressGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">EquivalentAddressGroup</span><span class="o">&gt;</span> <span class="n">equivalentAddressGroups</span> <span class="o">=</span> <span class="n">addressList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">EquivalentAddressGroup</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//3 命名解析完成 ResultionResult
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ResolutionResult</span> <span class="n">resolutionResult</span> <span class="o">=</span> <span class="n">ResolutionResult</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setAddresses</span><span class="o">(</span><span class="n">equivalentAddressGroups</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//监听名字解析的结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">onResult</span><span class="o">(</span><span class="n">resolutionResult</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="nf">getAddressList</span><span class="o">(</span><span class="n">String</span> <span class="n">authority</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HealthClient</span> <span class="n">healthClient</span> <span class="o">=</span> <span class="n">consul</span><span class="o">.</span><span class="na">healthClient</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ConsulResponse</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceHealth</span><span class="o">&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">healthClient</span><span class="o">.</span><span class="na">getHealthyServiceInstances</span><span class="o">(</span><span class="n">authority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceHealth</span><span class="o">&gt;</span> <span class="n">healthList</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">healthList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">ServiceHealth</span><span class="o">::</span><span class="n">getService</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">service</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(),</span> <span class="n">service</span><span class="o">.</span><span class="na">getPort</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">scheduledThreadPoolExecutor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>CustomNameResolverProvider</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomNameResolverProvider</span> <span class="kd">extends</span> <span class="n">NameResolverProvider</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">NameResolver</span> <span class="nf">newNameResolver</span><span class="o">(</span><span class="n">URI</span> <span class="n">targetUri</span><span class="o">,</span> <span class="n">NameResolver</span><span class="o">.</span><span class="na">Args</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomNameResolver</span><span class="o">(</span><span class="n">targetUri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//优先级应该高于DNS（5）命名服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">priority</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">6</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//名字解析 （注册中心）通信的协议 consul
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDefaultScheme</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;consul&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//作用：告知Grpc 自定义的ResolverProvider生效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isAvailable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>grpc客户端的开发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">原有的开发方式保留</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">引入自定义名字解析</span>
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="err">引入负载均衡的算法</span> 
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NameResolverGrpcClient</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1 引入新的命名解析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NameResolverRegistry</span><span class="o">.</span><span class="na">getDefaultRegistry</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomNameResolverProvider</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2客户端的开发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ManagedChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="o">.</span><span class="na">forTarget</span><span class="o">(</span><span class="s">&#34;grpc-server&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">usePlaintext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//3 引入负载均衡算法 round_robin轮训 负载均衡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">defaultLoadBalancingPolicy</span><span class="o">(</span><span class="s">&#34;round_robin&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//3 获得stub对象进行调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//模拟发送4次请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sendRequest</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">managedChannel</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendRequest</span><span class="o">(</span><span class="n">ManagedChannel</span> <span class="n">managedChannel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">HelloServiceBlockingStub</span> <span class="n">helloServiceBlockingStub</span> <span class="o">=</span> <span class="n">HelloServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">managedChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRespnose</span> <span class="n">helloRespnose</span> <span class="o">=</span> <span class="n">helloServiceBlockingStub</span><span class="o">.</span><span class="na">hello</span><span class="o">(</span><span class="n">HelloProto</span><span class="o">.</span><span class="na">HelloRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;xiaohei &#34;</span> <span class="o">+</span> <span class="n">idx</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;helloRespnose.getResult() = &#34;</span> <span class="o">+</span> <span class="n">helloRespnose</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="err">遗憾：内部集群名字的拼接有问题</span>
</span></span></code></pre></div></li>
<li>
<p>服务器坑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">在原始的gRPC与consul进行服务注册时，会产生一个Http2Connection异常。
</span></span><span class="line"><span class="cl">原因：
</span></span><span class="line"><span class="cl">   进行健康汇报检查时，consul代码会通过.check(Registration.RegCheck.tcp(address + &#34;:&#34; + port, 10))，向grpc-server发起访问，如果这个访问没有问题，则上报consul服务器，这样就完成了健康的检测。但是在.check(Registration.RegCheck.tcp(address + &#34;:&#34; + port, 10))向grpc-server发请求时，站在grpc-server的角度，他会认为这是一个普通的客户端方法，他需要建立Http2连接，而consul的客户端代码，是不支持http2协议，无法建立Http2的连接，所以就抛出Http2ConnectionHandler Broken pipe。
</span></span><span class="line"><span class="cl">注意：
</span></span><span class="line"><span class="cl">   <span class="k">1.</span> 这个异常不会影响到我们目前程序的运行。
</span></span><span class="line"><span class="cl">   <span class="k">2.</span> 不能为了取消这个异常，而不使用 .check(Registration.RegCheck.tcp(address + &#34;:&#34; + port, 10))。
</span></span><span class="line"><span class="cl">   <span class="k">3.</span> gRPC+consul+springboot ---&gt; springcloud
</span></span><span class="line"><span class="cl">      健康检查 springboot actuator进行整合 而不采用.check(Registration.RegCheck.tcp(address + &#34;:&#34; + port, 10))。
</span></span><span class="line"><span class="cl">      这样也就不会出现这个异常了。
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h6 id="634-grpc与springboot整合的高级应用" class="headerLink">
    <a href="#634-grpc%e4%b8%8espringboot%e6%95%b4%e5%90%88%e7%9a%84%e9%ab%98%e7%ba%a7%e5%ba%94%e7%94%a8" class="header-mark"></a>6.3.4 Grpc与SpringBoot整合的高级应用</h6><ul>
<li>
<p>拦截器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">开发一个拦截器</span> 
</span></span><span class="line"><span class="cl">   <span class="n">xxxxInterceptor</span>  <span class="kd">implements</span> <span class="n">ClientInterceptor</span> 
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomBootInterceptor</span> <span class="kd">implements</span> <span class="n">ClientInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">MethodDescriptor</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="n">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="n">Channel</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;这是拦截器 起作用了....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">引入拦截器</span>
</span></span><span class="line"><span class="cl"> <span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomBootInterceptorConfiguration</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//@Bean 让spring容器 认识这个Bean ,那Spring容器会不会把他当成grpc的拦截器呢？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@GrpcGlobalClientInterceptor</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CustomBootInterceptor</span> <span class="nf">customBootInterceptor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomBootInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">3.</span> <span class="err">第二种引入拦截器的方式</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@GrpcGlobalClientInterceptor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomBootInterceptor</span> <span class="kd">implements</span> <span class="n">ClientInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">ClientCall</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span><span class="n">MethodDescriptor</span><span class="o">&lt;</span><span class="n">ReqT</span><span class="o">,</span> <span class="n">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="n">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="n">Channel</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;这是拦截器 起作用了....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></li>
<li>
<p>consul注册中心[grpc替换 springcloud中 openFeign]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">服务器端开发</span> <span class="err">【</span><span class="n">nacos</span><span class="o">,</span><span class="n">zookeeper</span><span class="err">】</span>
</span></span><span class="line"><span class="cl">   <span class="mf">1.</span> <span class="err">依赖</span> 
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">consul</span><span class="o">-</span><span class="n">discovery</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">3.1.2</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">       <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="o">&lt;!--</span><span class="err">健康检查</span>  <span class="n">http</span><span class="err">协议</span> <span class="o">--&gt;</span>
</span></span><span class="line"><span class="cl">       <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">actuator</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="mf">2.</span> <span class="n">application</span><span class="o">.</span><span class="na">yml</span>
</span></span><span class="line"><span class="cl"><span class="nl">
</span></span></span><span class="line"><span class="cl"><span class="nl">        spring:</span>
</span></span><span class="line"><span class="cl">          <span class="n">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span><span class="o">:</span> <span class="n">boot</span><span class="o">-</span><span class="n">server</span>
</span></span><span class="line"><span class="cl">          <span class="n">cloud</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">consul</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">              <span class="n">discovery</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">register</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="n">hostname</span><span class="o">:</span> <span class="mf">127.0.0.1</span>
</span></span><span class="line"><span class="cl">                <span class="n">port</span><span class="o">:</span> <span class="mi">8500</span>
</span></span><span class="line"><span class="cl">                <span class="n">heartbeat</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">enabled</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="err">#</span>  <span class="n">main</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="err">#</span>    <span class="n">web</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">none</span>
</span></span><span class="line"><span class="cl"><span class="nl">
</span></span></span><span class="line"><span class="cl"><span class="nl">
</span></span></span><span class="line"><span class="cl"><span class="nl">        grpc:</span>
</span></span><span class="line"><span class="cl">          <span class="n">server</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">port</span><span class="o">:</span> <span class="mi">9000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="mf">3.</span> <span class="err">启动类</span>
</span></span><span class="line"><span class="cl">         <span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="err">注意事项：</span>
</span></span><span class="line"><span class="cl">          <span class="mf">1.</span> <span class="err">进行健康检查</span> <span class="n">heartbeat</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">          <span class="mf">2.</span> <span class="err">服务端做集群</span>
</span></span><span class="line"><span class="cl">          <span class="mf">3.</span> <span class="err">替换注册中心（</span><span class="n">consul</span> <span class="n">zk</span> <span class="n">nacos</span><span class="err">）</span>
</span></span><span class="line"><span class="cl">             <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/yidongnan/grpc-spring-boot-starter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>             <span class="mf">1.</span> <span class="err">替换</span><span class="n">cloud</span> <span class="err">依赖</span><span class="n">jar</span>
</span></span><span class="line"><span class="cl">             <span class="mf">2.</span> <span class="n">application</span><span class="o">.</span><span class="na">yml</span>
</span></span><span class="line"><span class="cl">                <span class="n">ip</span><span class="o">+</span><span class="n">port</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="err">客户端开发</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">consul</span><span class="o">-</span><span class="n">discovery</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">3.1.2</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">&lt;!--</span><span class="err">健康检查</span>  <span class="n">http</span><span class="err">协议</span> <span class="o">--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">actuator</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">.</span><span class="na">yml</span>
</span></span><span class="line"><span class="cl">          <span class="n">grpc</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">              <span class="n">cloud</span><span class="o">-</span><span class="n">grpc</span><span class="o">-</span><span class="n">server</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">address</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">discovery</span><span class="o">:</span><span class="c1">//boot-server&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">negotiation</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">plaintext</span>
</span></span><span class="line"><span class="cl">                <span class="n">enable</span><span class="o">-</span><span class="n">keep</span><span class="o">-</span><span class="n">alive</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="n">keep</span><span class="o">-</span><span class="n">alive</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">calls</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="err">通过这个注解进行注入：</span>
</span></span><span class="line"><span class="cl">              <span class="nd">@GrpcClient</span><span class="o">(</span><span class="s">&#34;cloud-grpc-server&#34;</span><span class="o">)</span>
</span></span></code></pre></div></li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-07-30</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"><button title="分享到 Twitter" data-sharer="twitter" data-url="https://sad-man-shang.github.io/grpc/" data-title="GRPC" data-via="Sadman_sq" data-hashtags="面试"><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer="facebook" data-url="https://sad-man-shang.github.io/grpc/" data-hashtag="面试"><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 Linkedin" data-sharer="linkedin" data-url="https://sad-man-shang.github.io/grpc/"><span class="fab fa-linkedin fa-fw"></span></button><button title="分享到 Evernote" data-sharer="evernote" data-url="https://sad-man-shang.github.io/grpc/" data-title="GRPC"><span class="fab fa-evernote fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E9%9D%A2%E8%AF%95/">面试</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E7%AC%94%E8%AF%95%E7%9C%9F%E9%A2%98/" class="prev" rel="prev" title="笔试真题"><i class="fas fa-angle-left fa-fw"></i>笔试真题</a>
            <a href="/parkmate/" class="next" rel="next" title="Parkmate">Parkmate<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">Sad man</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":0,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":true,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.9,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>